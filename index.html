<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV A√ßa√≠ da Serra - Touch</title>
    <link rel="icon" href="image/Icoacaidaserra.ico" type="image/x-icon">
    <!-- Links para os arquivos de Estilo e PDF -->
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<<<<<<< HEAD
=======
    <style>
        :root {
            --primary: #8A2BE2;
            --primary-dark: #6A1B9A;
            --secondary: #FF6B85;
            --light: #FFFFFF;
            --dark: #333333;
            --success: #4CAF50;
            --danger: #F44336;
            --warning: #FF9800; /* Laranja para "Pagamento Posterior" */
            --info: #2196F3; /* Azul para "Entrega" */
            --touch-size: 70px;
            --border-radius: 12px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #f4f4f9;
            color: var(--dark);
            line-height: 1.6;
            touch-action: manipulation;
            padding: 5px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 10px;
        }
        
        header {
            background: var(--light);
            color: var(--dark);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            text-align: center;
            position: relative;
            border: 1px solid #e0e0e0;
        }
        
        .logo-container {
            height: 150px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .current-date {
            margin-top: 5px;
            font-size: 14px;
            background: #f0f0f0;
            color: var(--dark);
            padding: 5px 10px;
            border-radius: 20px;
            display: inline-block;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative; /* Para o contador */
        }
        
        .tab.active {
            background: white;
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }
        
        .notification-badge {
            background-color: var(--danger);
            color: white;
            font-size: 12px;
            font-weight: bold;
            border-radius: 50%;
            padding: 2px 6px;
            margin-left: 8px;
            min-width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .section-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }
        
        .section-title {
            font-size: 18px;
            margin-bottom: 10px;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }
        
        .weight-controls {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .weight-input {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 18px;
            text-align: center;
            font-weight: bold;
        }
        
        .weight-input:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        .product-info {
            display: flex;
            justify-content: space-between;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .quick-add-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .quick-add-btn {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .quick-add-btn:active {
            transform: scale(0.98);
            background: #f0f0f0;
        }
        .quick-add-btn .price {
            font-size: 1rem;
            color: var(--primary);
            display: block;
            margin-top: 5px;
        }

        .product-type-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .product-type-selector .quick-add-btn {
            border: 2px solid #e0e0e0;
            background: white;
        }
        
        .product-type-selector .quick-add-btn.active {
            border-color: var(--primary);
            background: rgba(138, 43, 226, 0.1);
        }
        
        .delivery-mode-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .delivery-mode-btn {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .delivery-mode-btn.active {
            border-color: var(--info);
            background: rgba(33, 150, 243, 0.1);
        }
        .delivery-info-section {
            display: none; /* Oculto por padr√£o */
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .product-type-icon {
            width: 60px;
            height: 60px;
            margin-bottom: 8px;
            background-color: #fff;
            border-radius: 50%;
            border: 2px solid #f0f0f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex; 
            align-items: center; 
            justify-content: center;
        }
        
        .product-price {
            font-weight: bold;
            color: var(--primary);
            font-size: 16px;
        }
        
        .touch-btn {
            height: var(--touch-size);
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0 1rem;
        }
        
        .touch-btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: #e0e0e0; color: var(--dark); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        
        .cart-items {
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .cart-item:last-child { border-bottom: none; }
        
        .item-info { display: flex; align-items: center; gap: 10px; }
        .item-quantity {
            background: var(--primary); color: white; width: 25px; height: 25px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: bold; flex-shrink: 0;
        }
        .item-details { display: flex; flex-direction: column; }
        .item-name { font-weight: 600; color: #444; }
        .item-weight { font-size: 12px; color: #666; }
        .item-price { font-weight: bold; color: var(--primary); }
        .item-actions { display: flex; gap: 5px; }
        
        .btn-small {
            background: #f0f0f0; border: none; width: 35px; height: 35px;
            border-radius: 4px; cursor: pointer; display: flex;
            align-items: center; justify-content: center; font-size: 16px;
        }
        .btn-small:active { transform: scale(0.9); }
        .btn-remove { color: var(--danger); }
        
        .cart-summary { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-top: 10px; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: 600;}
        .total {
            font-size: 18px; font-weight: bold; color: var(--primary);
            border-top: 1px solid #ddd; padding-top: 10px;
        }
        
        .action-buttons { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 10px; 
            margin-top: 10px; 
        }
        .action-buttons .touch-btn {
            font-size: 1rem; 
            padding: 0 0.5rem;
            height: 65px;
        }
        
        .payment-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        
        .payment-option {
            padding: 20px 10px;
            border: 2px solid #e0e0e0; border-radius: 8px;
            text-align: center; cursor: pointer; transition: all 0.3s; font-weight: 600;
        }
        .payment-option.selected { border-color: var(--primary); background: rgba(138, 43, 226, 0.1); }
        .payment-option i { font-size: 24px; margin-bottom: 5px; display: block; }
        
        .cash-input { margin-top: 15px; display: none; }
        .cash-input input {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;
            font-size: 16px; margin-bottom: 10px; text-align: center;
        }
        .change-display {
            padding: 10px; background: #e8f5e9; border-radius: 6px; text-align: center;
            font-weight: bold; color: var(--success); display: none;
        }
        
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; align-items: stretch; }
        
        .open-orders-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
            gap: 10px; 
            align-items: stretch; 
        }
        
        .open-order-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid var(--primary-dark);
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .open-order-card:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); 
            border-color: var(--primary);
        }
        .open-order-icon { 
            font-size: 48px; 
            margin-bottom: 5px; 
            color: var(--primary); 
            line-height: 1;
        }
        .open-order-name { 
            font-weight: 600; 
            color: #444; 
            font-size: 1.1rem;
            word-wrap: break-word;
        }
        .open-order-total { 
            font-weight: bold; 
            color: var(--primary); 
            font-size: 1.2rem; 
        }
        
        .product-card {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .product-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        
        .product-image {
            width: 90px;
            height: 90px;
            background-color: #e0e0e0;
            border-radius: 8px;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #666;
            overflow: hidden;
        }
        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .product-details { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
        .product-name {
            font-weight: 600;
            color: #444;
            margin-bottom: 5px;
            word-wrap: break-word;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 40px;
        }
        .product-price-card { font-weight: bold; color: var(--primary); }
        
        .history-controls { display: grid; grid-template-columns: 1fr auto auto; gap: 10px; margin-bottom: 15px; align-items: center; }
        .date-selector { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        #add-manual-sale-btn, #export-history-pdf { height: auto; padding: 12px 15px; font-size: 16px; }
        
        .sales-history { max-height: 400px; overflow-y: auto; }
        
        .sale-item {
            padding: 12px 75px 12px 12px; 
            border-bottom: 1px solid #eee; display: flex;
            justify-content: space-between; align-items: center; position: relative;
        }
        .sale-item:hover { background: #f9f9f9; }
        
        .sale-info { display: flex; flex-direction: column; flex: 1; }
        .sale-date { font-size: 12px; color: #666; }
        .sale-items { font-size: 14px; margin: 5px 0; font-weight: 600;}
        
        .sale-open-time {
            font-size: 11px;
            color: #555;
            font-style: italic;
            font-weight: normal;
            margin-top: 3px;
        }
        
        .sale-payment { display: flex; align-items: center; gap: 5px; font-size: 14px; }
        .payment-icon { font-size: 16px; }
        .sale-total { font-weight: bold; color: var(--primary); font-size: 16px; }
        
        .delete-sale {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            background: none; border: none; color: var(--danger);
            cursor: pointer; font-size: 20px; opacity: 0.7;
        }
        .delete-sale:hover { opacity: 1; }
        
        .reprint-sale {
            position: absolute; 
            right: 45px; 
            top: 50%; 
            transform: translateY(-50%);
            background: none; border: none; color: var(--info);
            cursor: pointer; font-size: 20px; opacity: 0.7;
        }
        .reprint-sale:hover { opacity: 1; }
        
        .empty-state { text-align: center; padding: 30px; color: #666; }
        
        .admin-sub-tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #ddd; }
        .admin-sub-tab { padding: 10px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; }
        .admin-sub-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .admin-sub-content { display: none; }
        .admin-sub-content.active { display: block; }

        .admin-section { margin-bottom: 20px; }
        .admin-section h3 { margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; font-weight: 600; }
        .admin-controls { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; margin-bottom: 10px; }
        .admin-controls label { font-weight: 600; text-align: left;}
        .admin-input {
            padding: 10px; border: 1px solid #ddd; border-radius: 6px;
            font-size: 16px; width: 100%;
        }
        
        .login-form { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .login-form .touch-btn { grid-column: 1 / -1; }
        
        .logged-in { display: none; }
        .logged-in-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .user-info { font-weight: 600; color: var(--primary); }
        
        .products-management-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
        
        .notification {
            position: fixed; top: 20px; right: 20px; padding: 15px 20px;
            border-radius: 6px; color: white; font-weight: 600; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000; opacity: 0; transform: translateX(100%); transition: all 0.3s ease;
        }
        .notification.show { opacity: 1; transform: translateX(0); }
        .notification.success { background: var(--success); }
        .notification.error { background: var(--danger); }
        .notification.warning { background: var(--warning); }
        
        .products-categories { display: flex; overflow-x: auto; gap: 10px; margin-bottom: 15px; padding-bottom: 5px; }
        .category-btn {
            padding: 10px 15px; background: #f0f0f0; border: none;
            border-radius: 20px; cursor: pointer; white-space: nowrap; font-size: 14px; font-weight: 600;
        }
        .category-btn.active { background: var(--primary); color: white; }
        
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); z-index: 1001; align-items: center; justify-content: center;
        }
        
        .modal-content {
            background: white; padding: 20px; border-radius: 10px;
            width: 90%; max-width: 450px; text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-body {
            overflow-y: auto;
            text-align: left;
        }
        
        .password-input {
            width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ddd;
            border-radius: 6px; font-size: 16px; text-align: center;
        }
        
        #receipt-content {
            font-family: 'Courier New', monospace;
            text-align: left;
            padding: 15px;
            border: 1px solid #ccc;
            background: #fdfdfd;
            margin-bottom: 15px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .order-timer {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--danger);
            background: #f0f0f0;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }
        .open-order-items {
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            text-align: left;
        }
        .open-order-items .cart-item {
            padding: 8px;
            font-size: 14px;
        }
        .open-order-items .item-quantity {
            width: 20px; height: 20px; font-size: 11px;
        }
        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }


        @media (max-width: 768px) {
            .tabs {
                flex-wrap: wrap;
            }
            .tab {
                flex-basis: 50%;
                font-size: 0.9rem;
            }
            .touch-btn {
                font-size: 1rem;
                height: 65px;
            }
            .action-buttons {
                grid-template-columns: 1fr;
            }
            .action-buttons .touch-btn {
                font-size: 1.1rem;
                padding: 0 1rem;
            }
        }

        @media (max-width: 480px) {
            body {
                -webkit-text-size-adjust: 100%;
            }
            .container {
                padding: 0 5px;
            }
            .section-card {
                padding: 10px;
            }
            .weight-controls,
            .quick-add-buttons,
            .login-form,
            .delivery-mode-selector { /* Empilhar no mobile */
                grid-template-columns: 1fr;
            }
             .history-controls {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .touch-btn {
                height: 60px;
            }
            .sale-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                padding-bottom: 15px;
                padding-top: 15px;
            }
             .delete-sale, .reprint-sale { 
                top: 15px;
                transform: none;
            }
            .delete-sale { right: 5px; }
            .reprint-sale { right: 40px; }
            
            .modal-content {
                width: 95%;
            }
        }

    </style>
>>>>>>> ab2cce1b4a080953063d798756a6778ecf8529bd
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <img src="image/acaidaserra.png" alt="Logo da A√ßa√≠ da Serra" style="height: 250px;">
            </div>
            <div class="subtitle">Sistema para controle de vendas</div>
            <div class="current-date" id="current-date">--/--/----</div>
        </header>
        
        <!-- Abas de Navega√ß√£o (Nova aba "Despesas" adicionada) -->
        <div class="tabs">
            <div class="tab active" data-tab="venda">üõí <span>Venda</span></div>
            <div class="tab" data-tab="produtos">üç¶ <span>Produtos</span></div>
            <div class="tab" data-tab="comandas">
                <span>üìã</span> Comandas
                <span class="notification-badge" id="open-orders-count" style="display: none;">0</span>
            </div>
            <div class="tab" data-tab="historico">üìú <span>Hist√≥rico</span></div>
            <!-- NOVA ABA DE DESPESAS -->
            <div class="tab" data-tab="despesas">üí∏ <span>Despesas</span></div>
            <div class="tab" data-tab="admin">‚öôÔ∏è <span>Administrativo</span></div>
        </div>
        
        <!-- Conte√∫do da Aba: Venda -->
        <div class="tab-content active" id="venda-tab">
            <div class="section-card">
                <h2 class="section-title">
                    <span>Venda por KG</span>
                    <span class="product-price">R$ <span id="weighted-product-price-display">0.00</span>/kg</span>
                </h2>
                
                <div class="product-type-selector">
                    <button class="quick-add-btn active" data-type="acai">
                        <div class="product-type-icon">
                            <img src="image/acai.png" alt="√çcone de A√ßa√≠" style="width: 100%; height: 100%;">
                        </div>
                        A√ßa√≠
                    </button>
                    <button class="quick-add-btn" data-type="sorvete">
                        <div class="product-type-icon">
                           <img src="image/sorvete.png" alt="√çcone de Sorvete" style="width: 100%; height: 100%;">
                        </div>
                        Sorvete
                    </button>
                </div>
                
                <div class="weight-controls">
                    <input type="number" class="weight-input" id="weight-input" placeholder="Gramas" min="0">
                    <button id="add-to-cart" class="touch-btn btn-primary">Adicionar</button>
                </div>
                
                <div class="product-info">
                    <div>Valor calculado:</div>
                    <div class="product-price">R$ <span id="calculated-price">0.00</span></div>
                </div>

                <div class="quick-add-buttons">
                    <button class="quick-add-btn" data-product-id="1">
                        √Ågua <span class="price">R$ 3,00</span>
                    </button>
                    <button class="quick-add-btn" data-product-id="2">
                        √Ågua com G√°s <span class="price">R$ 3,00</span>
                    </button>
                </div>
            </div>
            
            <div class="section-card">
                <h2 class="section-title">Carrinho de Vendas</h2>
                <div class="cart-items" id="cart-items">
                    <div class="empty-state">Carrinho vazio</div>
                </div>
                
                <div class="cart-summary">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">R$ 0,00</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total:</span>
                        <span id="total">R$ 0,00</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button id="finish-sale" class="touch-btn btn-success">Finalizar Venda</button>
                    <button id="hold-sale" class="touch-btn btn-warning">Pagamento Posterior</button>
                    <button id="cancel-sale" class="touch-btn btn-danger">Cancelar Venda</button>
                </div>
            </div>
            
            <div class="section-card">
                <h2 class="section-title">Tipo de Venda</h2>
                <div class="delivery-mode-selector" id="delivery-mode-selector">
                    <button class="delivery-mode-btn active" data-mode="balcao">üè™ Balc√£o</button>
                    <button class="delivery-mode-btn" data-mode="entrega">üöö Entrega</button>
                </div>
                <div class="delivery-info-section" id="delivery-info-section" style="display: none;">
                    <input type="text" id="delivery-customer-name" class="admin-input" placeholder="Nome do Cliente">
                    <input type="text" id="delivery-customer-address" class="admin-input" placeholder="Endere√ßo">
                    <input type="number" id="delivery-fee" class="admin-input" placeholder="Valor da Entrega (R$)" min="0" step="0.01">
                </div>
            </div>
            
            <div class="section-card payment-section">
                <h2 class="section-title">Pagamento</h2>
                <div class="payment-options">
                    <div class="payment-option" data-method="cash"><i>üíµ</i><div>Dinheiro</div></div>
                    <div class="payment-option" data-method="card"><i>üí≥</i><div>Cart√£o</div></div>
                    <div class="payment-option" data-method="pix"><i>üì±</i><div>PIX</div></div>
                </div>
                
                <div class="cash-input" id="cash-input">
                    <input type="number" id="cash-received" placeholder="Valor recebido em R$">
                    <div class="change-display" id="change-display">
                        Troco: R$ <span id="change-amount">0,00</span>
                    </div>
                </div>
                
                <button id="confirm-payment" class="touch-btn btn-success" style="width: 100%; margin-top: 10px; display: none;">
                    Confirmar Pagamento
                </button>
            </div>
        </div>
        
        <!-- Conte√∫do da Aba: Produtos -->
        <div class="tab-content" id="produtos-tab">
            <div class="section-card">
                <h2 class="section-title">Produtos</h2>
                <div class="search-container" style="margin-bottom: 15px;">
                    <input type="search" id="product-search" class="admin-input" placeholder="üîç Pesquisar produto...">
                </div>
                <div class="products-categories" id="products-categories-list"></div>
                <div class="products-grid" id="products-grid"></div>
            </div>
        </div>
        
<<<<<<< HEAD
        <!-- Conte√∫do da Aba: Comandas -->
=======
>>>>>>> ab2cce1b4a080953063d798756a6778ecf8529bd
        <div class="tab-content" id="comandas-tab">
            <div class="section-card">
                <h2 class="section-title">Comandas em Aberto</h2>
                <div class="open-orders-grid" id="open-orders-grid">
                    <div class="empty-state">Nenhuma comanda em aberto</div>
                </div>
            </div>
        </div>
        
<<<<<<< HEAD
        <!-- Conte√∫do da Aba: Hist√≥rico (Sum√°rio Modificado) -->
=======
>>>>>>> ab2cce1b4a080953063d798756a6778ecf8529bd
        <div class="tab-content" id="historico-tab">
            <div class="section-card">
                <h2 class="section-title">Hist√≥rico de Vendas</h2>
                <div class="history-controls">
                    <input type="date" class="date-selector" id="history-date">
                    <button id="export-history-pdf" class="touch-btn btn-secondary">Exportar Dia</button>
                    <button id="add-manual-sale-btn" class="touch-btn btn-primary">Adicionar</button>
                </div>
                <div class="sales-history" id="sales-history">
                    <div class="empty-state">Nenhuma venda para esta data</div>
                </div>
                
<<<<<<< HEAD
                <!-- SUM√ÅRIO DO HIST√ìRICO MODIFICADO -->
=======
>>>>>>> ab2cce1b4a080953063d798756a6778ecf8529bd
                <div class="cart-summary" id="history-summary" style="margin-top: 15px; display: none;">
                    <div class="summary-row">
                        <span>Total em Produtos:</span>
                        <span id="history-products-total">R$ 0,00</span>
                    </div>
                    <div class="summary-row">
                        <span>Total em Entregas:</span>
                        <span id="history-delivery-total">R$ 0,00</span>
                    </div>
<<<<<<< HEAD
                    <!-- NOVA LINHA DE DESPESAS -->
                    <div class="summary-row" style="color: var(--danger);">
                        <span>Total em Despesas:</span>
                        <span id="history-expenses-total">R$ 0,00</span>
                    </div>
                    <div class="summary-row total">
                        <span>Saldo do Dia:</span>
=======
                    <div class="summary-row total">
                        <span>Total Geral do Dia:</span>
>>>>>>> ab2cce1b4a080953063d798756a6778ecf8529bd
                        <span id="history-grand-total">R$ 0,00</span>
                    </div>
                </div>
                </div>
        </div>
        
        <!-- NOVO CONTE√öDO DA ABA: Despesas -->
        <div class="tab-content" id="despesas-tab">
            <div class="section-card">
                <h2 class="section-title">Registrar Nova Despesa</h2>
                <div id="add-expense-form" class="admin-controls" style="grid-template-columns: 1fr; gap: 10px;">
                    <input type="text" id="new-expense-name" class="admin-input" placeholder="Nome da Despesa (Ex: G√°s, Aluguel)">
                    <input type="text" id="new-expense-desc" class="admin-input" placeholder="Descri√ß√£o (Opcional)">
                    <input type="number" id="new-expense-value" class="admin-input" placeholder="Valor (R$)">
                    <button id="add-new-expense-btn" class="touch-btn btn-primary" style="width:100%;">Adicionar Despesa</button>
                </div>
            </div>
            <div class="section-card">
                <h2 class="section-title">Despesas do Dia</h2>
                <div class="history-controls">
                    <input type="date" class="date-selector" id="expense-date">
                </div>
                <div class="sales-history" id="expenses-history-list">
                    <div class="empty-state">Nenhuma despesa para esta data</div>
                </div>
                <div class="cart-summary" id="expenses-summary" style="margin-top: 15px; display: none;">
                    <div class="summary-row total" style="color: var(--danger);">
                        <span>Total de Despesas do Dia:</span>
                        <span id="expenses-total-today">R$ 0,00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conte√∫do da Aba: Administrativo (Novas se√ß√µes) -->
        <div class="tab-content" id="admin-tab">
            <div class="section-card">
                <div id="login-section">
                    <h2 class="section-title">Acesso Restrito</h2>
                    <div class="login-form">
                        <input type="text" id="username" class="admin-input" placeholder="Usu√°rio" autocomplete="off">
                        <input type="password" id="password" class="admin-input" placeholder="Senha" autocomplete="off">
                        <button id="login-btn" class="touch-btn btn-primary">Entrar</button>
                    </div>
                </div>

                <div class="logged-in" id="admin-controls-panel">
                    <div class="logged-in-header">
                         <div class="user-info">Logado como: <span id="logged-user">Admin</span></div>
                         <button id="logout-btn" class="touch-btn btn-secondary" style="height: auto; padding: 10px 15px;">Sair</button>
                    </div>
                    
                    <!-- NOVAS SUB-ABAS (INCLUINDO RELAT√ìRIOS) -->
                    <div class="admin-sub-tabs">
                        <div class="admin-sub-tab active" data-subtab="produtos">Produtos e Pre√ßos</div>
                        <div class="admin-sub-tab" data-subtab="relatorios">Relat√≥rios</div>
                        <div class="admin-sub-tab" data-subtab="config">Configura√ß√µes</div>
                    </div>

                    <!-- Conte√∫do Sub-aba: Produtos -->
                    <div class="admin-sub-content active" id="admin-produtos-content">
                        <div class="admin-section">
                            <h3>Pre√ßo por KG</h3>
                            <div class="admin-controls">
                                <label for="acai-price">A√ßa√≠ (R$/kg)</label>
                                <input type="number" id="acai-price" class="admin-input" step="0.01">
                            </div>
                             <button id="update-acai-price" class="touch-btn btn-primary" style="width:100%; margin-bottom: 10px;">Atualizar Pre√ßo A√ßa√≠</button>
                             
                             <div class="admin-controls">
                                <label for="sorvete-price">Sorvete (R$/kg)</label>
                                <input type="number" id="sorvete-price" class="admin-input" step="0.01">
                            </div>
                             <button id="update-sorvete-price" class="touch-btn btn-primary" style="width:100%; margin-bottom: 10px;">Atualizar Pre√ßo Sorvete</button>
                        </div>
                        <div class="admin-section">
                            <h3>Adicionar Novo Produto</h3>
                            <div id="add-product-form" class="admin-controls" style="grid-template-columns: 1fr; gap: 10px;">
                                <input type="text" id="new-product-name" class="admin-input" placeholder="Nome do Produto">
                                <input type="number" id="new-product-price" class="admin-input" placeholder="Pre√ßo (R$)">
                                <input type="text" id="new-product-category" class="admin-input" placeholder="Categoria (ex: Bebidas, Doces)">
                                <button id="add-new-product-btn" class="touch-btn btn-primary" style="width:100%;">Adicionar Produto</button>
                            </div>
                        </div>
                        <div class="admin-section">
                            <h3>Gerenciar Produtos da Vitrine</h3>
                            <div class="products-management-grid" id="products-management"></div>
                        </div>
                    </div>
                    
                    <!-- NOVO CONTE√öDO SUB-ABA: RELAT√ìRIOS -->
                    <div class="admin-sub-content" id="admin-relatorios-content">
                        <div class="admin-section">
                            <h3>Relat√≥rio Mensal</h3>
                            <div class="admin-controls" style="grid-template-columns: 1fr; gap: 10px;">
                                <label for="report-month-select">Selecione o M√™s e Ano:</label>
                                <input type="month" id="report-month-select" class="admin-input">
                                <button id="generate-monthly-report-pdf" class="touch-btn btn-primary" style="width:100%;">Gerar PDF do M√™s</button>
                            </div>
                        </div>
                    </div>

                    <!-- Conte√∫do Sub-aba: Configura√ß√µes -->
                    <div class="admin-sub-content" id="admin-config-content">
                        <div class="admin-section">
                            <h3>Senha de Exclus√£o</h3>
                            <div class="admin-controls">
                                <label for="delete-password">Nova senha (4 d√≠gitos)</label>
                                <input type="password" id="delete-password" class="admin-input" maxlength="4">
                            </div>
                             <button id="update-delete-password" class="touch-btn btn-primary" style="width:100%;">Atualizar Senha</button>
                        </div>
                         <div class="admin-section">
                            <h3>Usu√°rios e Permiss√µes</h3>
                            <p class="empty-state" style="padding:10px;">(√Årea para futuras configura√ß√µes de usu√°rios)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modais (sem altera√ß√£o estrutural) -->
    <div class="modal" id="password-modal">
        <div class="modal-content">
            <h3>Excluir Item</h3>
            <p>Digite a senha para confirmar a exclus√£o:</p>
            <input type="password" class="password-input" id="confirm-delete-password" maxlength="4" placeholder="Senha">
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button id="confirm-delete" class="touch-btn btn-danger" style="flex: 1;">Confirmar</button>
                <button id="cancel-delete" class="touch-btn btn-secondary" style="flex: 1;">Cancelar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="receipt-modal">
        <div class="modal-content">
            <h3>Venda Finalizada</h3>
            <div id="receipt-content"></div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button id="print-receipt-btn" class="touch-btn btn-success" style="flex: 1;">Imprimir Recibo</button>
                <button id="close-receipt-btn" class="touch-btn btn-secondary" style="flex: 1;">Fechar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="manual-sale-modal">
        <div class="modal-content">
            <h3>Adicionar Venda Manual</h3>
            <div class="modal-body" id="manual-sale-form">
                <div class="admin-controls" style="grid-template-columns: 1fr; text-align: left;">
                    <label for="manual-product-select">Selecionar Produto:</label>
                    <select id="manual-product-select" class="admin-input"></select>
                </div>
                <div class="admin-controls" id="manual-acai-weight-section" style="display: none; grid-template-columns: 1fr; text-align: left;">
                    <label for="manual-acai-weight">Peso em Gramas:</label>
                    <input type="number" id="manual-acai-weight" class="admin-input" placeholder="Gramas">
                </div>
                <button id="manual-add-item-btn" class="touch-btn btn-primary" style="width: 100%; margin: 10px 0; height: 50px;">Adicionar Item</button>

                <h4>Itens da Venda</h4>
                <div class="cart-items" id="manual-sale-cart-items" style="max-height: 150px;">
                    <div class="empty-state">Nenhum item</div>
                </div>
                 <div class="cart-summary" id="manual-sale-summary" style="display: none;">
                    <div class="summary-row total">
                        <span>Total:</span>
                        <span id="manual-sale-total">R$ 0,00</span>
                    </div>
                </div>

                <h4>Pagamento</h4>
                <div class="payment-options" id="manual-payment-options">
                    <div class="payment-option" data-method="cash" style="padding: 10px;"><i>üíµ</i></div>
                    <div class="payment-option" data-method="card" style="padding: 10px;"><i>üí≥</i></div>
                    <div class="payment-option" data-method="pix" style="padding: 10px;"><i>üì±</i></div>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button id="save-manual-sale-btn" class="touch-btn btn-success" style="flex: 1;">Salvar Venda</button>
                <button id="close-manual-sale-btn" class="touch-btn btn-secondary" style="flex: 1;">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="hold-sale-modal">
        <div class="modal-content">
            <h3>Pagamento Posterior</h3>
            <div class="modal-body">
                <div class="form-group">
                    <label for="customer-name">Nome do Cliente (para identifica√ß√£o)</label>
                    <input type="text" id="customer-name" class="admin-input" placeholder="Ex: Mesa 02, Jo√£o, etc.">
                </div>
                <div class="form-group">
                    <label for="existing-order-select">Adicionar a uma comanda existente?</label>
                    <select id="existing-order-select" class="admin-input">
                        <option value="new">Salvar como nova comanda</option>
                    </select>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button id="save-hold-sale-btn" class="touch-btn btn-success" style="flex: 1;">Salvar Comanda</button>
                <button id="close-hold-sale-btn" class="touch-btn btn-secondary" style="flex: 1;">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="open-order-modal">
        <div class="modal-content">
            <h3 id="open-order-title">Finalizar Comanda</h3>
            <div class="modal-body">
                <div class="order-timer" id="open-order-timer">Tempo em aberto: 00:00</div>
                
                <h4>Itens da Comanda</h4>
                <div class="open-order-items" id="open-order-items-list">
                </div>
                
                <div class="cart-summary" style="margin-top: 0;">
                    <div class="summary-row total">
                        <span>Total:</span>
                        <span id="open-order-total">R$ 0,00</span>
                    </div>
                </div>
                
                <div class="payment-section" style="margin-top: 15px;">
                    <h2 class="section-title" style="font-size: 1.2rem; margin-bottom: 10px;">Forma de Pagamento</h2>
                    <div class="payment-options" id="open-order-payment-options">
                        <div class="payment-option" data-method="cash"><i>üíµ</i><div>Dinheiro</div></div>
                        <div class="payment-option" data-method="card"><i>üí≥</i><div>Cart√£o</div></div>
                        <div class="payment-option" data-method="pix"><i>üì±</i><div>PIX</div></div>
                    </div>
                    <div class="cash-input" id="open-order-cash-input">
                        <input type="number" id="open-order-cash-received" placeholder="Valor recebido em R$">
                        <div class="change-display" id="open-order-change-display">
                            Troco: R$ <span id="open-order-change-amount">0,00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button id="confirm-open-order-payment" class="touch-btn btn-success" style="flex: 1;">Confirmar Pagamento</button>
                <button id="close-open-order-btn" class="touch-btn btn-secondary" style="flex: 1;">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>

<<<<<<< HEAD
    <!-- Link para o arquivo JavaScript principal -->
    <script src="app.js"></script>
=======
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const App = {
            state: {
                cart: [],
                manualSaleCart: [],
                salesHistory: {},
                openOrders: [], 
                products: [
                    { id: 1, name: "√Ågua", price: 3.00, category: "Bebidas", image: "" }, 
                    { id: 2, name: "√Ågua com G√°s", price: 3.00, category: "Bebidas", image: "" }
                ],
                config: {
                    a√ßa√≠PricePerKg: 43.90,
                    sorvetePricePerKg: 43.90, 
                    deletePassword: '1015',
                },
                ui: {
                    currentWeightedProduct: 'acai', 
                    currentPaymentMethod: null,
                    manualSalePaymentMethod: null,
                    openOrderPaymentMethod: null, 
                    currentOpenOrder: null, 
                    openOrderTimerInterval: null, 
                    deliveryMode: 'balcao', 
                    isAdminLoggedIn: false,
                    saleToDelete: null,
                    lastSaleForReceipt: null,
                    today: new Date().toISOString().split('T')[0],
                }
            },
            
            DOM: {},

            init() {
                this.cacheDOM();
                this.storage.load();
                this.bindEvents();
                this.render.all();
            },

            cacheDOM() {
                this.DOM = {
                    container: document.querySelector('.container'),
                    currentDate: document.getElementById('current-date'),
                    weightInput: document.getElementById('weight-input'),
                    calculatedPrice: document.getElementById('calculated-price'),
                    weightedProductPriceDisplay: document.getElementById('weighted-product-price-display'),
                    productTypeSelector: document.querySelector('.product-type-selector'),
                    cartItems: document.getElementById('cart-items'),
                    subtotal: document.getElementById('subtotal'),
                    total: document.getElementById('total'),
                    paymentSection: document.querySelector('.payment-section'),
                    confirmPaymentButton: document.getElementById('confirm-payment'),
                    cashInputSection: document.getElementById('cash-input'),
                    cashReceivedInput: document.getElementById('cash-received'),
                    changeDisplay: document.getElementById('change-display'),
                    changeAmount: document.getElementById('change-amount'),
                    productSearch: document.getElementById('product-search'),
                    productsCategoriesList: document.getElementById('products-categories-list'),
                    productsGrid: document.getElementById('products-grid'),
                    historyDate: document.getElementById('history-date'),
                    salesHistory: document.getElementById('sales-history'),
                    
                    // *** IN√çCIO DA ALTERA√á√ÉO ***
                    historySummary: document.getElementById('history-summary'),
                    historyProductsTotal: document.getElementById('history-products-total'),
                    historyDeliveryTotal: document.getElementById('history-delivery-total'),
                    historyGrandTotal: document.getElementById('history-grand-total'),
                    // *** FIM DA ALTERA√á√ÉO ***

                    loginSection: document.getElementById('login-section'),
                    adminControlsPanel: document.getElementById('admin-controls-panel'),
                    acaiPriceInput: document.getElementById('acai-price'),
                    sorvetePriceInput: document.getElementById('sorvete-price'),
                    deletePasswordInput: document.getElementById('delete-password'),
                    productsManagement: document.getElementById('products-management'),
                    notification: document.getElementById('notification'),
                    passwordModal: document.getElementById('password-modal'),
                    confirmDeletePasswordInput: document.getElementById('confirm-delete-password'),
                    receiptModal: document.getElementById('receipt-modal'),
                    receiptContent: document.getElementById('receipt-content'),
                    manualSaleModal: document.getElementById('manual-sale-modal'),
                    manualProductSelect: document.getElementById('manual-product-select'),
                    manualAcaiWeightSection: document.getElementById('manual-acai-weight-section'),
                    manualAcaiWeightInput: document.getElementById('manual-acai-weight'),
                    manualSaleCartItems: document.getElementById('manual-sale-cart-items'),
                    manualSaleSummary: document.getElementById('manual-sale-summary'),
                    manualSaleTotal: document.getElementById('manual-sale-total'),
                    newProductName: document.getElementById('new-product-name'),
                    newProductPrice: document.getElementById('new-product-price'),
                    newProductCategory: document.getElementById('new-product-category'),
                    
                    holdSaleButton: document.getElementById('hold-sale'),
                    openOrdersCount: document.getElementById('open-orders-count'),
                    openOrdersGrid: document.getElementById('open-orders-grid'),
                    
                    holdSaleModal: document.getElementById('hold-sale-modal'),
                    customerNameInput: document.getElementById('customer-name'),
                    existingOrderSelect: document.getElementById('existing-order-select'),
                    saveHoldSaleButton: document.getElementById('save-hold-sale-btn'),
                    closeHoldSaleButton: document.getElementById('close-hold-sale-btn'),
                    
                    openOrderModal: document.getElementById('open-order-modal'),
                    openOrderTitle: document.getElementById('open-order-title'),
                    openOrderTimer: document.getElementById('open-order-timer'),
                    openOrderItemsList: document.getElementById('open-order-items-list'),
                    openOrderTotal: document.getElementById('open-order-total'),
                    openOrderPaymentOptions: document.getElementById('open-order-payment-options'),
                    openOrderCashInput: document.getElementById('open-order-cash-input'),
                    openOrderCashReceived: document.getElementById('open-order-cash-received'),
                    openOrderChangeDisplay: document.getElementById('open-order-change-display'),
                    openOrderChangeAmount: document.getElementById('open-order-change-amount'),
                    confirmOpenOrderPaymentButton: document.getElementById('confirm-open-order-payment'),
                    closeOpenOrderButton: document.getElementById('close-open-order-btn'),

                    deliveryModeSelector: document.getElementById('delivery-mode-selector'),
                    deliveryInfoSection: document.getElementById('delivery-info-section'),
                    deliveryCustomerName: document.getElementById('delivery-customer-name'),
                    deliveryCustomerAddress: document.getElementById('delivery-customer-address'),
                    deliveryFee: document.getElementById('delivery-fee'), 
                };
            },

            bindEvents() {
                this.DOM.weightInput.addEventListener('input', (e) => this.handlers.calculateWeightedPrice(e));
                document.getElementById('add-to-cart').addEventListener('click', () => this.handlers.addWeightedProductToCart());
                if (this.DOM.productTypeSelector) {
                    this.DOM.productTypeSelector.querySelectorAll('.quick-add-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => this.handlers.selectWeightedProduct(e.currentTarget.dataset.type));
                    });
                }
                document.getElementById('add-new-product-btn').addEventListener('click', () => this.handlers.addNewProduct());
                document.querySelectorAll('.quick-add-btn[data-product-id]').forEach(btn => btn.addEventListener('click', (e) => this.handlers.addQuickProduct(e)));
                document.getElementById('finish-sale').addEventListener('click', () => this.handlers.preparePayment());
                document.getElementById('cancel-sale').addEventListener('click', () => this.handlers.cancelSale());
                document.querySelectorAll('#venda-tab .payment-option').forEach(el => el.addEventListener('click', () => this.handlers.selectPaymentMethod(el)));
                this.DOM.confirmPaymentButton.addEventListener('click', () => this.handlers.confirmPayment());
                this.DOM.cashReceivedInput.addEventListener('input', () => this.handlers.calculateChange());
                this.DOM.productSearch.addEventListener('input', () => this.render.products());
                this.DOM.historyDate.addEventListener('change', (e) => this.render.history(e.target.value));
                document.getElementById('add-manual-sale-btn').addEventListener('click', () => this.handlers.openManualSaleModal());
                document.getElementById('export-history-pdf').addEventListener('click', () => this.handlers.exportHistoryToPDF());
                document.getElementById('login-btn').addEventListener('click', () => this.handlers.login());
                document.getElementById('logout-btn').addEventListener('click', () => this.handlers.logout());
                document.getElementById('update-acai-price').addEventListener('click', () => this.handlers.updateAcaiPrice());
                document.getElementById('update-sorvete-price').addEventListener('click', () => this.handlers.updateSorvetePrice());
                document.getElementById('update-delete-password').addEventListener('click', () => this.handlers.updateDeletePassword());
                document.getElementById('print-receipt-btn').addEventListener('click', () => this.handlers.printLastReceiptModal());
                document.getElementById('close-receipt-btn').addEventListener('click', () => this.DOM.receiptModal.style.display = 'none');
                document.getElementById('confirm-delete').addEventListener('click', () => this.handlers.confirmDeleteSale());
                document.getElementById('cancel-delete').addEventListener('click', () => {
                    this.DOM.passwordModal.style.display = 'none';
                    this.DOM.confirmDeletePasswordInput.value = '';
                });
                document.getElementById('close-manual-sale-btn').addEventListener('click', () => this.DOM.manualSaleModal.style.display = 'none');
                this.DOM.manualProductSelect.addEventListener('change', (e) => this.handlers.toggleManualWeightInput(e));
                document.getElementById('manual-add-item-btn').addEventListener('click', () => this.handlers.addManualItem());
                document.getElementById('save-manual-sale-btn').addEventListener('click', () => this.handlers.saveManualSale());
                document.querySelectorAll('#manual-payment-options .payment-option').forEach(el => el.addEventListener('click', () => this.handlers.selectManualPaymentMethod(el)));
                document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', (e) => this.handlers.switchTab(e.currentTarget.dataset.tab)));
                document.querySelectorAll('.admin-sub-tab').forEach(t => t.addEventListener('click', (e) => this.handlers.switchAdminSubTab(e.currentTarget.dataset.subtab)));
                
                this.DOM.container.addEventListener('click', (e) => {
                    if (e.target.matches('.cart-item .btn-remove')) this.handlers.removeFromCart(e.target.dataset.index);
                    if (e.target.matches('#manual-sale-cart-items .btn-remove')) this.handlers.removeManualItem(e.target.dataset.index);
                    if (e.target.matches('.sales-history .delete-sale')) this.handlers.requestDeleteSale(e.target);
                    if (e.target.matches('.sales-history .reprint-sale')) {
                        this.handlers.reprintSale(e.target);
                    }
                    if (e.target.matches('.delete-product-btn')) this.handlers.deleteProduct(e.target.dataset.id);
                });
                
                this.DOM.holdSaleButton.addEventListener('click', () => this.handlers.requestHoldSale());
                this.DOM.saveHoldSaleButton.addEventListener('click', () => this.handlers.saveHoldSale());
                this.DOM.closeHoldSaleButton.addEventListener('click', () => this.DOM.holdSaleModal.style.display = 'none');
                
                this.DOM.openOrdersGrid.addEventListener('click', (e) => {
                    const card = e.target.closest('.open-order-card');
                    if (card) {
                        this.handlers.openOrderDetails(parseInt(card.dataset.id));
                    }
                });
                
                this.DOM.closeOpenOrderButton.addEventListener('click', () => this.handlers.closeOpenOrderModal());
                this.DOM.openOrderPaymentOptions.querySelectorAll('.payment-option').forEach(el => {
                    el.addEventListener('click', () => this.handlers.selectOpenOrderPaymentMethod(el));
                });
                this.DOM.openOrderCashReceived.addEventListener('input', () => this.handlers.calculateOpenOrderChange());
                this.DOM.confirmOpenOrderPaymentButton.addEventListener('click', () => this.handlers.finalizeOpenOrderPayment());

                this.DOM.deliveryModeSelector.querySelectorAll('.delivery-mode-btn').forEach(btn => {
                    btn.addEventListener('click', (e)=> this.handlers.selectDeliveryMode(e.currentTarget.dataset.mode));
                });
                
                this.DOM.deliveryFee.addEventListener('input', () => this.render.cart());
            },

            handlers: {
                switchTab(tabName) {
                    document.querySelector('.tab.active').classList.remove('active');
                    document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(`${tabName}-tab`).classList.add('active');
                },
                switchAdminSubTab(subTabName) {
                      document.querySelector('.admin-sub-tab.active').classList.remove('active');
                      document.querySelector(`.admin-sub-tab[data-subtab="${subTabName}"]`).classList.add('active');
                      document.querySelectorAll('.admin-sub-content').forEach(c => c.classList.remove('active'));
                      document.getElementById(`admin-${subTabName}-content`).classList.add('active');
                },
                selectWeightedProduct(type) {
                    App.state.ui.currentWeightedProduct = type;
                    App.render.weightedProductSelector();
                    App.render.weightedProductPrice();
                    const event = new Event('input', { bubbles: true, cancelable: true });
                    App.DOM.weightInput.dispatchEvent(event);
                },
                calculateWeightedPrice(e) {
                    const weight = parseFloat(e.target.value) || 0;
                    const pricePerKg = App.state.ui.currentWeightedProduct === 'acai'
                        ? App.state.config.a√ßa√≠PricePerKg
                        : App.state.config.sorvetePricePerKg;
                    App.DOM.calculatedPrice.textContent = (weight / 1000 * pricePerKg).toFixed(2);
                },
                
                calculateChange() {
                    let subtotal = App.state.cart.reduce((sum, item) => sum + item.totalPrice, 0);
                    let deliveryFee = 0;
                    if (App.state.ui.deliveryMode === 'entrega') {
                        deliveryFee = parseFloat(App.DOM.deliveryFee.value) || 0;
                    }
                    const total = subtotal + deliveryFee;
                    
                    const received = parseFloat(App.DOM.cashReceivedInput.value) || 0;
                    if (received >= total) {
                        App.DOM.changeAmount.textContent = (received - total).toFixed(2);
                        App.DOM.changeDisplay.style.display = 'block';
                    } else {
                        App.DOM.changeDisplay.style.display = 'none';
                    }
                },
                addWeightedProductToCart() {
                    const weight = parseFloat(App.DOM.weightInput.value);
                    if (!weight || weight <= 0) return App.utils.showNotification('Digite um peso v√°lido.', 'error');
                    
                    const type = App.state.ui.currentWeightedProduct;
                    const pricePerKg = type === 'acai'
                        ? App.state.config.a√ßa√≠PricePerKg
                        : App.state.config.sorvetePricePerKg;
                    const name = type === 'acai' ? 'A√ßa√≠ por KG' : 'Sorvete por KG';

                    const price = (weight / 1000) * pricePerKg;
                    App.state.cart.push({ id: Date.now(), name, pricePerKg, weightGrams: weight, totalPrice: price, type: "weight" });
                    App.render.cart(); 
                    App.utils.showNotification(`${name} (${weight}g) adicionado.`, 'success');
                    App.DOM.weightInput.value = '';
                    App.DOM.calculatedPrice.textContent = '0.00';
                },
                addQuickProduct(e) {
                    const productId = parseInt(e.currentTarget.dataset.productId);
                    const product = App.state.products.find(p => p.id === productId);
                    if (product) this.addProductToCart(product);
                },
                addProductToCart(product) {
                    App.state.cart.push({ id: Date.now(), name: product.name, totalPrice: product.price, type: "product" });
                    App.render.cart(); 
                    App.utils.showNotification(`${product.name} adicionado.`, 'success');
                },
                removeFromCart(index) {
                    const removed = App.state.cart.splice(index, 1)[0];
                    App.render.cart(); 
                    App.utils.showNotification(`${removed.name} removido.`, 'warning');
                },
                preparePayment() {
                    if (App.state.cart.length > 0) {
                        App.DOM.confirmPaymentButton.style.display = 'flex';
                        App.DOM.paymentSection.scrollIntoView({ behavior: 'smooth' });
                    } else App.utils.showNotification('Carrinho vazio.', 'error');
                },
                selectPaymentMethod(el) {
                    App.state.ui.currentPaymentMethod = el.dataset.method;
                    document.querySelectorAll('#venda-tab .payment-option').forEach(o => o.classList.remove('selected'));
                    el.classList.add('selected');
                    App.DOM.cashInputSection.style.display = (el.dataset.method === 'cash') ? 'block' : 'none';
                    this.calculateChange();
                },

                selectDeliveryMode(mode) {
                    App.state.ui.deliveryMode = mode;
                    App.render.deliveryMode();
                    App.render.cart(); 
                },

                confirmPayment() {
                    const { ui, cart, salesHistory } = App.state;
                    if (!ui.currentPaymentMethod) return App.utils.showNotification('Selecione uma forma de pagamento.', 'error');
                    
                    const deliveryMode = App.state.ui.deliveryMode;
                    const customerName = App.DOM.deliveryCustomerName.value;
                    const customerAddress = App.DOM.deliveryCustomerAddress.value;
                    const deliveryFee = parseFloat(App.DOM.deliveryFee.value) || 0;
                    
                    const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);
                    const total = subtotal + (deliveryMode === 'entrega' ? deliveryFee : 0);

                    if (ui.currentPaymentMethod === 'cash') {
                        const received = parseFloat(App.DOM.cashReceivedInput.value) || 0;
                        if (received < total) return App.utils.showNotification(`Valor insuficiente.`, 'error');
                    }
                    
                    if (deliveryMode === 'entrega' && deliveryFee <= 0) {
                        if (!confirm('O Valor da Entrega est√° R$ 0,00. Deseja continuar mesmo assim?')) {
                            return; 
                        }
                    }
                    if (deliveryMode === 'entrega' && (!customerName || !customerAddress)) {
                        if (!confirm('O nome do cliente ou endere√ßo n√£o foi preenchido. Deseja continuar mesmo assim?')) {
                            return; 
                        }
                    }
                    
                    const deliveryInfo = {
                        mode: deliveryMode,
                        name: customerName,
                        address: customerAddress,
                        fee: deliveryFee
                    };
                    
                    const sale = {
                        id: Date.now(), date: new Date().toLocaleString('pt-BR'), dateKey: ui.today,
                        items: [...cart], 
                        total: total, 
                        paymentMethod: ui.currentPaymentMethod,
                        cashReceived: ui.currentPaymentMethod === 'cash' ? (parseFloat(App.DOM.cashReceivedInput.value) || 0) : null,
                        change: ui.currentPaymentMethod === 'cash' ? ((parseFloat(App.DOM.cashReceivedInput.value) || 0) - total) : null,
                        openTimeMinutes: 0,
                        deliveryInfo: deliveryInfo 
                    };
                    
                    if (!salesHistory[ui.today]) salesHistory[ui.today] = [];
                    salesHistory[ui.today].unshift(sale);
                    App.storage.saveSalesHistory();
                    App.utils.showNotification(`Venda finalizada!`, 'success');
                    App.render.history(ui.today);
                    ui.lastSaleForReceipt = sale;
                    App.utils.showReceiptModal(sale);
                    this.resetSaleState();
                },

                resetSaleState() {
                    App.state.cart = [];
                    App.state.ui.currentPaymentMethod = null;
                    App.DOM.confirmPaymentButton.style.display = 'none';
                    App.DOM.cashInputSection.style.display = 'none';
                    App.DOM.cashReceivedInput.value = '';
                    App.DOM.changeDisplay.style.display = 'none';
                    App.DOM.changeAmount.textContent = '0,00';
                    document.querySelectorAll('#venda-tab .payment-option').forEach(el => el.classList.remove('selected'));
                    
                    App.handlers.selectDeliveryMode('balcao');
                    App.DOM.deliveryCustomerName.value = '';
                    App.DOM.deliveryCustomerAddress.value = '';
                    App.DOM.deliveryFee.value = ''; 
                    
                    App.render.cart(); 
                },
                cancelSale() {
                    if (App.state.cart.length > 0 && confirm('Tem certeza que deseja cancelar a venda?')) {
                        this.resetSaleState(); 
                        App.utils.showNotification('Venda cancelada.', 'warning');
                    }
                },
                
                requestHoldSale() {
                    if (App.state.cart.length === 0) {
                        return App.utils.showNotification('Carrinho vazio.', 'error');
                    }
                    
                    const { existingOrderSelect } = App.DOM;
                    existingOrderSelect.innerHTML = '<option value="new">Salvar como nova comanda</option>';
                    App.state.openOrders.forEach(order => {
                        const option = document.createElement('option');
                        option.value = order.id;
                        option.textContent = `${order.customerName} (R$ ${order.total.toFixed(2)})`;
                        existingOrderSelect.appendChild(option);
                    });
                    
                    App.DOM.customerNameInput.value = App.DOM.deliveryCustomerName.value;
                    App.DOM.holdSaleModal.style.display = 'flex';
                    App.DOM.customerNameInput.focus();
                },
                
                saveHoldSale() {
                    const { customerNameInput, existingOrderSelect } = App.DOM;
                    const customerName = customerNameInput.value.trim();
                    const selectedOrderId = existingOrderSelect.value;
                    
                    if (selectedOrderId === 'new' && !customerName) {
                        return App.utils.showNotification('Digite um nome para a nova comanda.', 'error');
                    }
                    
                    const deliveryInfo = {
                        mode: App.state.ui.deliveryMode,
                        name: App.DOM.deliveryCustomerName.value,
                        address: App.DOM.deliveryCustomerAddress.value,
                        fee: parseFloat(App.DOM.deliveryFee.value) || 0
                    };
                    
                    if (selectedOrderId === 'new') {
                        const subtotal = App.state.cart.reduce((sum, item) => sum + item.totalPrice, 0);
                        const total = subtotal + (deliveryInfo.mode === 'entrega' ? deliveryInfo.fee : 0);

                        const newOrder = {
                            id: Date.now(),
                            customerName: customerName,
                            items: [...App.state.cart],
                            total: total,
                            createdAt: new Date().toISOString(),
                            deliveryInfo: deliveryInfo 
                        };
                        App.state.openOrders.push(newOrder);
                        App.utils.showNotification(`Nova comanda salva para "${customerName}".`, 'success');
                    } else {
                        const orderId = parseInt(selectedOrderId);
                        const order = App.state.openOrders.find(o => o.id === orderId);
                        if (order) {
                            order.items.push(...App.state.cart);
                            const itemsTotal = order.items.reduce((sum, item) => sum + item.totalPrice, 0);
                            const fee = (order.deliveryInfo && order.deliveryInfo.mode === 'entrega') ? order.deliveryInfo.fee : 0;
                            order.total = itemsTotal + fee;
                            App.utils.showNotification(`Itens adicionados √† comanda de "${order.customerName}".`, 'success');
                        }
                    }
                    
                    App.storage.saveOpenOrders();
                    App.render.openOrdersGrid();
                    App.handlers.resetSaleState();
                    App.DOM.holdSaleModal.style.display = 'none';
                },
                
                openOrderDetails(orderId) {
                    const order = App.state.openOrders.find(o => o.id === orderId);
                    if (!order) return;
                    
                    App.state.ui.currentOpenOrder = order;
                    App.state.ui.openOrderPaymentMethod = null;

                    App.DOM.openOrderTitle.textContent = `Comanda: ${order.customerName}`;
                    App.DOM.openOrderTotal.textContent = `R$ ${order.total.toFixed(2)}`;
                    App.DOM.openOrderCashReceived.value = '';
                    App.DOM.openOrderChangeDisplay.style.display = 'none';
                    App.DOM.openOrderCashInput.style.display = 'none';
                    App.DOM.openOrderPaymentOptions.querySelectorAll('.payment-option').forEach(o => o.classList.remove('selected'));
                    
                    App.render.openOrderItems(order.items, order.deliveryInfo); 
                    
                    if (App.state.ui.openOrderTimerInterval) {
                        clearInterval(App.state.ui.openOrderTimerInterval);
                    }
                    const startTime = new Date(order.createdAt).getTime();
                    App.state.ui.openOrderTimerInterval = setInterval(() => {
                        App.render.openOrderTimer(startTime);
                    }, 1000);
                    App.render.openOrderTimer(startTime);
                    
                    App.DOM.openOrderModal.style.display = 'flex';
                },
                
                closeOpenOrderModal() {
                    if (App.state.ui.openOrderTimerInterval) {
                        clearInterval(App.state.ui.openOrderTimerInterval);
                    }
                    App.state.ui.currentOpenOrder = null;
                    App.state.ui.openOrderTimerInterval = null;
                    App.DOM.openOrderModal.style.display = 'none';
                },
                
                selectOpenOrderPaymentMethod(el) {
                    App.state.ui.openOrderPaymentMethod = el.dataset.method;
                    App.DOM.openOrderPaymentOptions.querySelectorAll('.payment-option').forEach(o => o.classList.remove('selected'));
                    el.classList.add('selected');
                    App.DOM.openOrderCashInput.style.display = (el.dataset.method === 'cash') ? 'block' : 'none';
                    this.calculateOpenOrderChange();
                },
                
                calculateOpenOrderChange() {
                    const order = App.state.ui.currentOpenOrder;
                    if (!order) return;
                    
                    const received = parseFloat(App.DOM.openOrderCashReceived.value) || 0;
                    if (received >= order.total) {
                        App.DOM.openOrderChangeAmount.textContent = (received - order.total).toFixed(2);
                        App.DOM.openOrderChangeDisplay.style.display = 'block';
                    } else {
                        App.DOM.openOrderChangeDisplay.style.display = 'none';
                    }
                },
                
                finalizeOpenOrderPayment() {
                    const { ui, salesHistory } = App.state;
                    const order = ui.currentOpenOrder;
                    const paymentMethod = ui.openOrderPaymentMethod;
                    
                    if (!order) return App.utils.showNotification('Erro: Nenhuma comanda selecionada.', 'error');
                    if (!paymentMethod) return App.utils.showNotification('Selecione uma forma de pagamento.', 'error');
                    
                    const deliveryInfo = order.deliveryInfo || { mode: 'balcao', name: '', address: '', fee: 0 };
                    
                    if (deliveryInfo.mode === 'entrega' && (!deliveryInfo.fee || deliveryInfo.fee <= 0)) {
                        if (!confirm('Esta comanda de entrega est√° com a taxa R$ 0,00. Deseja continuar mesmo assim?')) {
                            return; 
                        }
                    }
                    if (deliveryInfo.mode === 'entrega' && (!deliveryInfo.name || !deliveryInfo.address)) {
                         if (!confirm('Esta comanda de entrega n√£o tem nome ou endere√ßo. Deseja continuar mesmo assim?')) {
                            return; 
                        }
                    }

                    let cashReceived = null;
                    let change = null;
                    
                    if (paymentMethod === 'cash') {
                        cashReceived = parseFloat(App.DOM.openOrderCashReceived.value) || 0;
                        if (cashReceived < order.total) {
                            return App.utils.showNotification(`Valor insuficiente.`, 'error');
                        }
                        change = cashReceived - order.total;
                    }
                    
                    const startTime = new Date(order.createdAt).getTime();
                    const endTime = new Date().getTime();
                    const openTimeMinutes = (endTime - startTime) / (1000 * 60);
                    
                    const sale = {
                        id: order.id, 
                        date: new Date().toLocaleString('pt-BR'), 
                        dateKey: ui.today,
                        items: [...order.items], 
                        total: order.total, 
                        paymentMethod: paymentMethod,
                        cashReceived: cashReceived,
                        change: change,
                        openTimeMinutes: openTimeMinutes,
                        deliveryInfo: deliveryInfo 
                    };
                    
                    if (!salesHistory[ui.today]) salesHistory[ui.today] = [];
                    salesHistory[ui.today].unshift(sale);
                    App.storage.saveSalesHistory();
                    
                    App.state.openOrders = App.state.openOrders.filter(o => o.id !== order.id);
                    App.storage.saveOpenOrders();
                    
                    App.utils.showNotification(`Comanda de "${order.customerName}" finalizada!`, 'success');
                    App.render.history(ui.today);
                    App.render.openOrdersGrid();
                    
                    ui.lastSaleForReceipt = sale;
                    App.utils.showReceiptModal(sale);
                    this.closeOpenOrderModal();
                },

                login() {
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    const isAdmin = (username === 'admin' && password === 'qwe102030');
                    const isCreator = (username === 'admcarll' && password === '15243qwe');
                    const isBreno = (username === 'brenomacedo' && password === '070824');
                    if (isAdmin || isCreator || isBreno) {
                        App.state.ui.isAdminLoggedIn = true;
                        App.DOM.loginSection.style.display = 'none';
                        App.DOM.adminControlsPanel.style.display = 'block';
                        document.getElementById('logged-user').textContent = username; 
                        App.utils.showNotification('Login realizado com sucesso.', 'success');
                    } else {
                        App.utils.showNotification('Usu√°rio ou senha incorretos.', 'error');
                    }
                },
                logout() {
                    App.state.ui.isAdminLoggedIn = false;
                    App.DOM.loginSection.style.display = 'block';
                    App.DOM.adminControlsPanel.style.display = 'none';
                    
                    document.getElementById('username').value = '';
                    document.getElementById('password').value = '';
                },
                updateAcaiPrice() {
                    if(!App.state.ui.isAdminLoggedIn) return App.utils.showNotification('Acesso negado.', 'error');
                    App.state.config.a√ßa√≠PricePerKg = parseFloat(App.DOM.acaiPriceInput.value);
                    App.storage.saveConfig();
                    App.render.weightedProductPrice();
                    App.utils.showNotification('Pre√ßo do a√ßa√≠ atualizado.', 'success');
                },
                updateSorvetePrice() {
                    if(!App.state.ui.isAdminLoggedIn) return App.utils.showNotification('Acesso negado.', 'error');
                    App.state.config.sorvetePricePerKg = parseFloat(App.DOM.sorvetePriceInput.value);
                    App.storage.saveConfig();
                    App.render.weightedProductPrice();
                    App.utils.showNotification('Pre√ßo do sorvete atualizado.', 'success');
                },
                updateDeletePassword() {
                    if(!App.state.ui.isAdminLoggedIn) return App.utils.showNotification('Acesso negado.', 'error');
                    App.state.config.deletePassword = App.DOM.deletePasswordInput.value;
                    App.storage.saveConfig();
                    App.utils.showNotification('Senha de exclus√£o atualizada.', 'success');
                },
                addNewProduct() {
                    if (!App.state.ui.isAdminLoggedIn) return App.utils.showNotification('Acesso negado.', 'error');
                    const name = App.DOM.newProductName.value.trim();
                    const price = parseFloat(App.DOM.newProductPrice.value);
                    const category = App.DOM.newProductCategory.value.trim() || 'Geral';
                    if (!name || !price || price <= 0) {
                        return App.utils.showNotification('Por favor, preencha nome e pre√ßo v√°lidos.', 'error');
                    }
                    const newProduct = { id: Date.now(), name, price, category, image: "" };
                    App.state.products.push(newProduct);
                    App.storage.saveProducts();
                    App.utils.showNotification(`Produto "${name}" adicionado com sucesso!`, 'success');
                    App.DOM.newProductName.value = '';
                    App.DOM.newProductPrice.value = '';
                    App.DOM.newProductCategory.value = '';
                    App.render.products();
                    App.render.adminProducts();
                    App.render.productCategories();
                },
                deleteProduct(productId) {
                    if (!App.state.ui.isAdminLoggedIn) return App.utils.showNotification('Acesso negado.', 'error');
                    const idToDelete = parseInt(productId);
                    const productIndex = App.state.products.findIndex(p => p.id === idToDelete);
                    if (productIndex > -1) {
                        if (confirm(`Tem certeza que deseja excluir o produto "${App.state.products[productIndex].name}"?`)) {
                            const removed = App.state.products.splice(productIndex, 1)[0];
                            App.storage.saveProducts();
                            App.utils.showNotification(`Produto "${removed.name}" exclu√≠do.`, 'warning');
                            App.render.products();
                            App.render.adminProducts();
                            App.render.productCategories();
                        }
                    }
                },
                requestDeleteSale(target) {
                    App.state.ui.saleToDelete = { id: parseInt(target.dataset.id), date: target.dataset.date };
                    App.DOM.passwordModal.style.display = 'flex';
                },
                confirmDeleteSale() {
                    if (App.DOM.confirmDeletePasswordInput.value === App.state.config.deletePassword) {
                        const {id, date} = App.state.ui.saleToDelete;
                        const saleIndex = App.state.salesHistory[date].findIndex(s => s.id === id);
                        if (saleIndex > -1) {
                            App.state.salesHistory[date].splice(saleIndex, 1);
                            App.storage.saveSalesHistory();
                            App.render.history(date);
                            App.utils.showNotification('Venda exclu√≠da.', 'success');
                        }
                    } else {
                        App.utils.showNotification('Senha incorreta.', 'error');
                    }
                    App.DOM.passwordModal.style.display = 'none';
                    App.DOM.confirmDeletePasswordInput.value = '';
                },
                
                reprintSale(target) {
                    const id = parseInt(target.dataset.id);
                    const date = target.dataset.date;
                    
                    if (!id || !date || !App.state.salesHistory[date]) {
                        return App.utils.showNotification("Erro ao localizar venda.", "error");
                    }
                    
                    const saleToReprint = App.state.salesHistory[date].find(s => s.id === id);
                    
                    if (saleToReprint) {
                        App.handlers.printReceipt(saleToReprint);
                    } else {
                        App.utils.showNotification("Venda n√£o encontrada.", "error");
                    }
                },
                
                openManualSaleModal() {
                    App.state.manualSaleCart = [];
                    App.state.ui.manualSalePaymentMethod = null;
                    App.render.manualSaleCart();
                    App.DOM.manualProductSelect.innerHTML = '<option value="">Selecione...</option><option value="acai_kg">A√ßa√≠ por KG</option><option value="sorvete_kg">Sorvete por KG</option>';
                    App.state.products.forEach(p => {
                        App.DOM.manualProductSelect.innerHTML += `<option value="${p.id}">${p.name} - R$ ${p.price.toFixed(2)}</option>`;
                    });
                    App.DOM.manualAcaiWeightSection.style.display = 'none';
                    document.querySelectorAll('#manual-payment-options .payment-option').forEach(el => el.classList.remove('selected'));
                    App.DOM.manualSaleModal.style.display = 'flex';
                },
                toggleManualWeightInput(e) {
                    App.DOM.manualAcaiWeightSection.style.display = (e.target.value === 'acai_kg' || e.target.value === 'sorvete_kg') ? 'grid' : 'none';
                },
                addManualItem() {
                    const selectedId = App.DOM.manualProductSelect.value;
                    if (!selectedId) return;
                    if (selectedId === 'acai_kg' || selectedId === 'sorvete_kg') {
                        const weight = parseFloat(App.DOM.manualAcaiWeightInput.value);
                        if (!weight || weight <= 0) return App.utils.showNotification('Digite um peso v√°lido.', 'error');
                        const isAcai = selectedId === 'acai_kg';
                        const pricePerKg = isAcai ? App.state.config.a√ßa√≠PricePerKg : App.state.config.sorvetePricePerKg;
                        const name = isAcai ? "A√ßa√≠ por KG" : "Sorvete por KG";
                        const price = (weight / 1000) * pricePerKg;
                        App.state.manualSaleCart.push({ id: Date.now(), name, weightGrams: weight, totalPrice: price, type: 'weight' });
                    } else {
                        const product = App.state.products.find(p => p.id === parseInt(selectedId));
                        if (product) App.state.manualSaleCart.push({ id: Date.now(), name: product.name, totalPrice: product.price, type: 'product' });
                    }
                    App.render.manualSaleCart();
                },
                removeManualItem(index) {
                    App.state.manualSaleCart.splice(index, 1);
                    App.render.manualSaleCart();
                },
                selectManualPaymentMethod(el) {
                    App.state.ui.manualSalePaymentMethod = el.dataset.method;
                    document.querySelectorAll('#manual-payment-options .payment-option').forEach(o => o.classList.remove('selected'));
                    el.classList.add('selected');
                },
                saveManualSale() {
                    const saleDate = App.DOM.historyDate.value;
                    if (App.state.manualSaleCart.length === 0) return App.utils.showNotification('Adicione itens √† venda.', 'error');
                    if (!App.state.ui.manualSalePaymentMethod) return App.utils.showNotification('Selecione um m√©todo de pagamento.', 'error');
                    const total = App.state.manualSaleCart.reduce((sum, item) => sum + item.totalPrice, 0);
                    
                    const sale = {
                        id: Date.now(), date: new Date(saleDate + 'T12:00:00').toLocaleString('pt-BR'), dateKey: saleDate,
                        items: [...App.state.manualSaleCart], total, paymentMethod: App.state.ui.manualSalePaymentMethod,
                        openTimeMinutes: 0,
                        deliveryInfo: { mode: 'balcao', name: '', address: '', fee: 0 } 
                    };
                    
                    if (!App.state.salesHistory[saleDate]) App.state.salesHistory[saleDate] = [];
                    App.state.salesHistory[saleDate].unshift(sale);
                    App.storage.saveSalesHistory();
                    App.utils.showNotification('Venda manual salva com sucesso!', 'success');
                    App.render.history(saleDate);
                    App.DOM.manualSaleModal.style.display = 'none';
                },
                
                exportHistoryToPDF() {
                    const date = App.DOM.historyDate.value;
                    const salesForDate = App.state.salesHistory[date] || [];
                    if (salesForDate.length === 0) {
                        return App.utils.showNotification('Nenhuma venda para exportar nesta data.', 'warning');
                    }
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const formattedDate = new Date(date + 'T12:00:00').toLocaleDateString('pt-BR');
                    doc.setFontSize(18);
                    doc.text(`Relat√≥rio de Vendas - ${formattedDate}`, 14, 22);
                    const tableColumn = ["Hora", "Itens", "Pagamento", "Total (R$)"];
                    const tableRows = [];
                    
                    // *** IN√çCIO DA ALTERA√á√ÉO ***
                    let totalGeral = 0;
                    let totalProdutos = 0;
                    let totalEntregas = 0;
                    // *** FIM DA ALTERA√á√ÉO ***

                    salesForDate.forEach(sale => {
                        let itemsString = sale.items.map(i => {
                            const detail = i.weightGrams ? `(${i.weightGrams}g)` : '';
                            return `- ${i.name} ${detail} [R$ ${i.totalPrice.toFixed(2)}]`;
                        }).join('\n');
                        
                        if (sale.openTimeMinutes && sale.openTimeMinutes > 0) {
                            itemsString += `\n(Aberta por: ${sale.openTimeMinutes.toFixed(0)} min)`;
                        }
                        
                        // *** IN√çCIO DA ALTERA√á√ÉO ***
                        const taxaEntrega = (sale.deliveryInfo && sale.deliveryInfo.mode === 'entrega' && sale.deliveryInfo.fee > 0) ? sale.deliveryInfo.fee : 0;
                        const valorProdutos = sale.total - taxaEntrega;

                        if (sale.deliveryInfo && sale.deliveryInfo.mode === 'entrega') {
                             const fee = sale.deliveryInfo.fee ? ` (Taxa: R$ ${sale.deliveryInfo.fee.toFixed(2)})` : '';
                             itemsString += `\n(Entrega: ${sale.deliveryInfo.name || 'N/A'}${fee})`;
                        }
                        // *** FIM DA ALTERA√á√ÉO ***

                        let paymentString = App.utils.getPaymentMethodName(sale.paymentMethod);
                        if (sale.paymentMethod === 'cash' && sale.change > 0) {
                            paymentString += `\n(Troco: R$ ${sale.change.toFixed(2)})`;
                        }

                        const saleData = [
                            sale.date.split(' ')[1],
                            itemsString,
                            paymentString,
                            sale.total.toFixed(2)
                        ];
                        tableRows.push(saleData);
                        
                        // *** IN√çCIO DA ALTERA√á√ÉO ***
                        totalGeral += sale.total;
                        totalProdutos += valorProdutos;
                        totalEntregas += taxaEntrega;
                        // *** FIM DA ALTERA√á√ÉO ***
                    });
                    
                    doc.autoTable({
                        head: [tableColumn],
                        body: tableRows,
                        startY: 30,
                        styles: { cellPadding: 2, fontSize: 8, halign: 'left', valign: 'top' },
                        headStyles: { fillColor: [138, 43, 226], halign: 'center' },
                        alternateRowStyles: { fillColor: [245, 245, 245] },
                        columnStyles: {
                           0: { halign: 'center', cellWidth: 20 },
                           1: { cellWidth: 80 },
                           2: { halign: 'center', cellWidth: 30 },
                           3: { halign: 'right', cellWidth: 25 }
                        }
                    });
                    
                    const finalY = doc.lastAutoTable.finalY;
                    
                    // *** IN√çCIO DA ALTERA√á√ÉO ***
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Total em Produtos: R$ ${totalProdutos.toFixed(2)}`, 14, finalY + 10);
                    doc.text(`Total em Entregas: R$ ${totalEntregas.toFixed(2)}`, 14, finalY + 15);
                    
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Total Geral (Produtos + Entregas): R$ ${totalGeral.toFixed(2)}`, 14, finalY + 22);
                    // *** FIM DA ALTERA√á√ÉO ***

                    doc.save(`relatorio_vendas_${date}.pdf`);
                    App.utils.showNotification('PDF gerado com sucesso!', 'success');
                },
                
                printLastReceiptModal() {
                    const sale = App.state.ui.lastSaleForReceipt;
                    if (sale) {
                        App.handlers.printReceipt(sale);
                    } else {
                        App.utils.showNotification("Nenhuma venda recente para imprimir.", "error");
                    }
                },
                
                printReceipt(sale) {
                    if (!sale) return App.utils.showNotification("N√£o foi poss√≠vel encontrar a venda para imprimir.", "error");
                    
                    let deliveryHtml = '';
                    const fee = (sale.deliveryInfo && sale.deliveryInfo.mode === 'entrega' && sale.deliveryInfo.fee > 0) ? sale.deliveryInfo.fee : 0;
                    const feeHtml = fee > 0 ? `<div class="item"><span class="item-name">Taxa Entrega</span><span class="item-price">R$ ${fee.toFixed(2)}</span></div>` : '';

                    if (sale.deliveryInfo && sale.deliveryInfo.mode === 'entrega') {
                        deliveryHtml = `
                            <div class="divider"></div>
                            <div class="item" style="text-align: center; display: block; margin-bottom: 5px;"><strong>*** ENTREGA ***</strong></div>
                            ${sale.deliveryInfo.name ? `<div class="item"><span>Cliente:</span><span style="text-align:right;">${sale.deliveryInfo.name}</span></div>` : ''}
                            ${sale.deliveryInfo.address ? `<div class="item"><span>Endere√ßo:</span><span style="text-align:right;">${sale.deliveryInfo.address}</span></div>` : ''}
                        `;
                    }
                    
                    const printContent = `<!DOCTYPE html><html><head><title>Recibo</title><style>
                        @page{ size: 78mm auto; margin: 0; padding: 0; }
                        body {
                            font-family: 'Courier New', monospace;
                            font-size: 12px;
                            color: #000;
                            font-weight: bold;
                            width: 78mm; 
                            margin: 0;
                            padding: 5px 5px 20px 5px;
                            box-sizing: border-box;
                            background: #fff;
                        }
                        .header{text-align:center;margin-bottom:8px;padding-bottom:5px;border-bottom:1px dashed #000}
                        .header h2{font-size:16px;font-weight:700;margin:5px 0;text-transform:uppercase}
                        .header p{margin:3px 0;font-size:10px}
                        .item{display:flex;justify-content:space-between;margin-bottom:4px;line-height:1.3}
                        .item-name{flex-grow:1;text-align:left;word-break:break-word}
                        .item-price{width:80px;text-align:right;flex-shrink:0;}
                        .divider{border-top:1px dashed #000;margin:8px 0}
                        .total{font-weight:700;margin-top:8px;font-size:14px}
                        .payment-info{margin:8px 0;font-size:10px}
                        .footer{text-align:center;margin-top:10px;font-size:9px;border-top:1px dashed #000;padding-top:5px}
                        @media print{
                            body {
                                margin: 0;
                                padding: 5px 5px 20px 5px;
                                width: 78mm; 
                                color: #000 !important;
                                font-weight: bold !important;
                                -webkit-print-color-adjust: exact;
                            }
                        }
                        </style></head><body>
                        <div class="header"><h2>A√ßa√≠ da Serra</h2><p>${new Date().toLocaleString('pt-BR')}</p></div>
                        ${deliveryHtml} 
                        <div class="divider"></div>
                        ${sale.items.map(item => `<div class="item"><span class="item-name">${item.name} ${item.weightGrams ? `(${item.weightGrams}g)` : ''}</span><span class="item-price">R$ ${item.totalPrice.toFixed(2)}</span></div>`).join('')}
                        ${feeHtml}
                        <div class="divider"></div>
                        <div class="item total"><span>TOTAL:</span><span>R$ ${sale.total.toFixed(2)}</span></div>
                        <div class="payment-info">
                            <div class="item"><span>Pagamento:</span><span>${App.utils.getPaymentMethodName(sale.paymentMethod)}</span></div>
                            ${sale.paymentMethod === 'cash' ? `<div class="item"><span>Recebido:</span><span>R$ ${sale.cashReceived.toFixed(2)}</span></div><div class="item"><span>Troco:</span><span>R$ ${sale.change.toFixed(2)}</span></div>` : ''}
                        </div>
                        <div class="footer"><p>Obrigado pela prefer√™ncia!</p><p>Volte Sempre!</p></div>
                        <script>window.onload=()=>{setTimeout(()=>{window.print();setTimeout(()=>window.close(),100)},100)}<\/script>
                    </body></html>`;
                    
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(printContent);
                    printWindow.document.close();
                },
            },

            render: {
                all() {
                    App.DOM.currentDate.textContent = new Date().toLocaleDateString('pt-BR');
                    App.DOM.historyDate.value = App.state.ui.today;
                    App.DOM.acaiPriceInput.value = App.state.config.a√ßa√≠PricePerKg.toFixed(2);
                    App.DOM.sorvetePriceInput.value = App.state.config.sorvetePricePerKg.toFixed(2);
                    App.DOM.deletePasswordInput.value = App.state.config.deletePassword;
                    this.weightedProductPrice();
                    this.cart();
                    this.productCategories();
                    this.products();
                    this.history(App.state.ui.today);
                    this.adminProducts();
                    this.openOrdersGrid();
                    this.deliveryMode(); 
                },
                cart() {
                    const { cartItems, subtotal, total } = App.DOM;
                    cartItems.innerHTML = '';
                    
                    let currentSubtotal = 0;
                    if (App.state.cart.length > 0) {
                        App.state.cart.forEach((item, index) => {
                            currentSubtotal += item.totalPrice;
                            const itemElement = document.createElement('div');
                            itemElement.className = 'cart-item';
                            const details = (item.type === "weight") ? `<div class="item-weight">${item.weightGrams}g</div>` : '';
                            itemElement.innerHTML = `<div class="item-info"><div class="item-quantity">${index + 1}</div><div class="item-details"><div class="item-name">${item.name}</div>${details}</div></div><div class="item-price">R$ ${item.totalPrice.toFixed(2)}</div><div class="item-actions"><button class="btn-small btn-remove" data-index="${index}">‚úï</button></div>`;
                            cartItems.appendChild(itemElement);
                        });
                    } else {
                         cartItems.innerHTML = '<div class="empty-state">Carrinho vazio</div>';
                    }
                    
                    let deliveryFee = 0;
                    if (App.state.ui.deliveryMode === 'entrega') {
                        deliveryFee = parseFloat(App.DOM.deliveryFee.value) || 0;
                    }
                    const currentTotal = currentSubtotal + deliveryFee;
                    
                    subtotal.textContent = `R$ ${currentSubtotal.toFixed(2)}`;
                    total.textContent = `R$ ${currentTotal.toFixed(2)}`;
                },
                products() {
                    const searchTerm = App.DOM.productSearch.value.toLowerCase();
                    const activeCategoryEl = App.DOM.productsCategoriesList.querySelector('.category-btn.active');
                    const activeCategory = activeCategoryEl ? activeCategoryEl.dataset.category : 'all';
                    let filtered = [...App.state.products];
                    if (activeCategory !== 'all') filtered = filtered.filter(p => p.category === activeCategory);
                    if (searchTerm) filtered = filtered.filter(p => p.name.toLowerCase().includes(searchTerm));
                    
                    App.DOM.productsGrid.innerHTML = '';
                    if (filtered.filter(p => p.category !== 'Bebidas').length === 0) {
                        App.DOM.productsGrid.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;">Nenhum produto encontrado.</div>';
                    }
                    filtered.filter(p => p.category !== 'Bebidas').forEach(product => {
                        const card = document.createElement('div');
                        card.className = 'product-card';
                        const imageHtml = product.image ? `<img src="${product.image}" alt="${product.name}">` : '';
                        card.innerHTML = `<div class="product-image">${imageHtml}</div><div class="product-details"><div class="product-name">${product.name}</div><div class="product-price-card">R$ ${product.price.toFixed(2)}</div></div>`;
                        card.addEventListener('click', () => App.handlers.addProductToCart(product));
                        App.DOM.productsGrid.appendChild(card);
                    });

                    const quickAddButtons = document.querySelector('.quick-add-buttons');
                    quickAddButtons.innerHTML = '';
                     filtered.filter(p => p.category === 'Bebidas').forEach(product => {
                        const button = document.createElement('button');
                        button.className = 'quick-add-btn';
                        button.dataset.productId = product.id;
                        button.innerHTML = `${product.name} <span class="price">R$ ${product.price.toFixed(2)}</span>`;
                        button.addEventListener('click', (e) => App.handlers.addQuickProduct(e));
                        quickAddButtons.appendChild(button);
                    });
                },
                productCategories() {
                    const categories = ['all', ...new Set(App.state.products.map(p => p.category))];
                    App.DOM.productsCategoriesList.innerHTML = categories.map(c => `<button class="category-btn ${c==='all'?'active':''}" data-category="${c}">${c==='all'?'Todos':c}</button>`).join('');
                    App.DOM.productsCategoriesList.querySelectorAll('.category-btn').forEach(b => b.addEventListener('click', () => {
                        const currentActive = App.DOM.productsCategoriesList.querySelector('.category-btn.active');
                        if(currentActive) currentActive.classList.remove('active');
                        b.classList.add('active');
                        this.products();
                    }));
                },
                
                // *** FUN√á√ÉO ALTERADA ***
                history(date) {
                    App.DOM.salesHistory.innerHTML = '';
                    
                    // Pega os elementos do DOM do sum√°rio
                    const { salesHistory, historySummary, historyProductsTotal, historyDeliveryTotal, historyGrandTotal } = App.DOM;
                    
                    const salesForDate = App.state.salesHistory[date] || [];
                    
                    // Zera os contadores
                    let totalGeral = 0;
                    let totalProdutos = 0;
                    let totalEntregas = 0;

                    if (salesForDate.length === 0) {
                        salesHistory.innerHTML = '<div class="empty-state">Nenhuma venda para esta data</div>';
                        historySummary.style.display = 'none'; // Esconde o sum√°rio
                        return;
                    }

                    salesForDate.forEach(sale => {
                        const item = document.createElement('div');
                        item.className = 'sale-item';
                        
                        // C√°lculos para o sum√°rio
                        const taxaEntrega = (sale.deliveryInfo && sale.deliveryInfo.mode === 'entrega' && sale.deliveryInfo.fee > 0) ? sale.deliveryInfo.fee : 0;
                        const valorProdutos = sale.total - taxaEntrega;
                        
                        totalGeral += sale.total;
                        totalProdutos += valorProdutos;
                        totalEntregas += taxaEntrega;
                        // Fim dos c√°lculos
                        
                        const itemsHtml = sale.items.map(i => {
                            const detail = i.weightGrams ? `(${i.weightGrams}g)` : '';
                            return `<div class="sale-item-detail" style="font-size: 13px;">- ${i.name} ${detail}</div>`;
                        }).join('');
                        
                        const openTimeHtml = (sale.openTimeMinutes && sale.openTimeMinutes > 0)
                            ? `<div class="sale-open-time">(Aberta por: ${sale.openTimeMinutes.toFixed(0)} min)</div>` 
                            : '';
                        
                        let deliveryHtml = '';
                        if (sale.deliveryInfo && sale.deliveryInfo.mode === 'entrega') {
                            const name = sale.deliveryInfo.name ? ` (${sale.deliveryInfo.name})` : '';
                            const fee = sale.deliveryInfo.fee ? ` (Taxa: R$ ${sale.deliveryInfo.fee.toFixed(2)})` : '';
                            deliveryHtml = `<div class="sale-open-time" style="color: var(--info); font-weight: bold;">üöö Entrega${name}${fee}</div>`;
                        }

                        const paymentDetails = sale.paymentMethod === 'cash' && sale.change > 0
                            ? ` (Troco: R$ ${sale.change.toFixed(2)})`
                            : '';

                        item.innerHTML = `
                            <div class="sale-info">
                                <div class="sale-date">${sale.date}</div>
                                <div class="sale-items">${itemsHtml}${openTimeHtml}${deliveryHtml}</div>
                                <div class="sale-payment">
                                    <span class="payment-icon">${App.utils.getPaymentIcon(sale.paymentMethod)}</span> 
                                    ${App.utils.getPaymentMethodName(sale.paymentMethod)}${paymentDetails}
                                </div>
                            </div>
                            <div class="sale-total">R$ ${sale.total.toFixed(2)}</div>
                            <button class="reprint-sale" data-id="${sale.id}" data-date="${date}" title="Reimprimir Recibo">üñ®Ô∏è</button>
                            <button class="delete-sale" data-id="${sale.id}" data-date="${date}" title="Excluir Venda">‚úï</button>
                        `;
                        
                        salesHistory.appendChild(item);
                    });

                    // Renderiza os totais no sum√°rio e o exibe
                    historyProductsTotal.textContent = `R$ ${totalProdutos.toFixed(2)}`;
                    historyDeliveryTotal.textContent = `R$ ${totalEntregas.toFixed(2)}`;
                    historyGrandTotal.textContent = `R$ ${totalGeral.toFixed(2)}`;
                    historySummary.style.display = 'block';
                },
                // *** FIM DA FUN√á√ÉO ALTERADA ***
                
                deliveryMode() {
                    const mode = App.state.ui.deliveryMode;
                    App.DOM.deliveryModeSelector.querySelectorAll('.delivery-mode-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.mode === mode);
                    });
                    App.DOM.deliveryInfoSection.style.display = (mode === 'entrega') ? 'grid' : 'none';
                },
                
                openOrdersGrid() {
                    const { openOrdersGrid, openOrdersCount } = App.DOM;
                    openOrdersGrid.innerHTML = '';
                    const orders = App.state.openOrders;
                    
                    if (orders.length === 0) {
                        openOrdersGrid.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;">Nenhuma comanda em aberto</div>';
                        openOrdersCount.style.display = 'none';
                        return;
                    }
                    
                    orders.forEach(order => {
                        const card = document.createElement('div');
                        card.className = 'open-order-card';
                        card.dataset.id = order.id;
                        card.innerHTML = `
                            <div class="open-order-icon">üìã</div>
                            <div class="open-order-name">${order.customerName}</div>
                            <div class="open-order-total">R$ ${order.total.toFixed(2)}</div>
                        `;
                        openOrdersGrid.appendChild(card);
                    });
                    
                    openOrdersCount.textContent = orders.length;
                    openOrdersCount.style.display = 'inline-flex';
                },
                
                openOrderItems(items, deliveryInfo) {
                    const { openOrderItemsList } = App.DOM;
                    openOrderItemsList.innerHTML = '';
                    if (items.length === 0) {
                        openOrderItemsList.innerHTML = '<div class="empty-state">Nenhum item</div>';
                        return;
                    }
                    items.forEach((item, index) => {
                        const itemElement = document.createElement('div');
                        itemElement.className = 'cart-item';
                        const details = (item.type === "weight") ? `<div class="item-weight">${item.weightGrams}g</div>` : '';
                        itemElement.innerHTML = `
                            <div class="item-info">
                                <div class="item-quantity">${index + 1}</div>
                                <div class="item-details">
                                    <div class="item-name">${item.name}</div>
                                    ${details}
                                </div>
                            </div>
                            <div class="item-price">R$ ${item.totalPrice.toFixed(2)}</div>
                        `;
                        openOrderItemsList.appendChild(itemElement);
                    });
                    
                    if (deliveryInfo && deliveryInfo.mode === 'entrega' && deliveryInfo.fee > 0) {
                        const feeElement = document.createElement('div');
                        feeElement.className = 'cart-item';
                        feeElement.innerHTML = `
                            <div class="item-info">
                                <div class="item-quantity"></div>
                                <div class="item-details">
                                    <div class="item-name" style="font-weight: bold;">Taxa Entrega</div>
                                </div>
                            </div>
                            <div class="item-price" style="font-weight: bold;">R$ ${deliveryInfo.fee.toFixed(2)}</div>
                        `;
                        openOrderItemsList.appendChild(feeElement);
                    }
                },
                
                openOrderTimer(startTime) {
                    const now = new Date().getTime();
                    const diff = now - startTime;
                    const minutes = Math.floor(diff / 60000);
                    const seconds = Math.floor((diff % 60000) / 1000);
                    App.DOM.openOrderTimer.textContent = `Aberta por: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                },
                
                adminProducts() {
                    App.DOM.productsManagement.innerHTML = '';
                    App.state.products.forEach(product => {
                        const control = document.createElement('div');
                        control.className = 'admin-controls';
                        control.innerHTML = `
                            <label>${product.name}</label>
                            <input type="number" class="admin-input product-price-input" data-id="${product.id}" value="${product.price.toFixed(2)}" step="0.01">
                        `;

                        const buttonContainer = document.createElement('div');
                        buttonContainer.style.cssText = 'grid-column: 1 / -1; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;';

                        const updateBtn = document.createElement('button');
                        updateBtn.className = 'touch-btn btn-primary';
                        updateBtn.style.cssText = 'height: auto; padding: 10px; font-size: 1rem;';
                        updateBtn.textContent = 'Atualizar';
                        updateBtn.addEventListener('click', () => {
                            if(!App.state.ui.isAdminLoggedIn) return;
                            const priceInput = control.querySelector(`.product-price-input`);
                            const newPrice = parseFloat(priceInput.value);
                            const productIndex = App.state.products.findIndex(p => p.id === product.id);
                            if (newPrice >= 0 && productIndex !== -1) {
                                App.state.products[productIndex].price = newPrice;
                                App.storage.saveProducts();
                                App.utils.showNotification(`Pre√ßo de ${App.state.products[productIndex].name} atualizado.`, 'success');
                                this.products();
                                this.adminProducts();
                                this.productCategories();
                            } else App.utils.showNotification('Pre√ßo inv√°lido.', 'error');
                        });

                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'touch-btn btn-danger delete-product-btn';
                        deleteBtn.style.cssText = 'height: auto; padding: 10px; font-size: 1rem;';
                        deleteBtn.textContent = 'Excluir';
                        deleteBtn.dataset.id = product.id;

                        buttonContainer.appendChild(updateBtn);
                        buttonContainer.appendChild(deleteBtn);
                        control.appendChild(buttonContainer);
                        App.DOM.productsManagement.appendChild(control);
                    });
                },
                 manualSaleCart() {
                    const { manualSaleCartItems, manualSaleSummary, manualSaleTotal } = App.DOM;
                    manualSaleCartItems.innerHTML = '';
                    if (App.state.manualSaleCart.length === 0) {
                        manualSaleCartItems.innerHTML = '<div class="empty-state">Nenhum item</div>';
                        manualSaleSummary.style.display = 'none';
                        return;
                    }
                    let total = 0;
                    App.state.manualSaleCart.forEach((item, index) => {
                         total += item.totalPrice;
                         const itemElement = document.createElement('div');
                         itemElement.className = 'cart-item';
                         const details = item.weightGrams ? `<div class="item-weight">${item.weightGrams}g</div>` : '';
                         itemElement.innerHTML = `<div class="item-info"><div class="item-quantity">${index+1}</div><div class="item-details"><div class="item-name">${item.name}</div>${details}</div></div><div class="item-price">R$ ${item.totalPrice.toFixed(2)}</div><button class="btn-small btn-remove" data-index="${index}">‚úï</button>`;
                         manualSaleCartItems.appendChild(itemElement);
                    });
                    manualSaleTotal.textContent = `R$ ${total.toFixed(2)}`;
                    manualSaleSummary.style.display = 'block';
                },
                weightedProductPrice() {
                    const price = App.state.ui.currentWeightedProduct === 'acai'
                        ? App.state.config.a√ßa√≠PricePerKg
                        : App.state.config.sorvetePricePerKg;
                    App.DOM.weightedProductPriceDisplay.textContent = price.toFixed(2);
                },
                weightedProductSelector() {
                    if (!App.DOM.productTypeSelector) return;
                    App.DOM.productTypeSelector.querySelectorAll('.quick-add-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.type === App.state.ui.currentWeightedProduct);
                    });
                },
            },

            utils: {
                getPaymentMethodName: (m) => ({ cash: 'Dinheiro', card: 'Cart√£o', pix: 'PIX' }[m] || 'N/A'),
                getPaymentIcon: (m) => ({ cash: 'üíµ', card: 'üí≥', pix: 'üì±' }[m] || '‚ùì'),
                showNotification: (message, type) => {
                    App.DOM.notification.textContent = message;
                    App.DOM.notification.className = `notification ${type} show`;
                    setTimeout(() => App.DOM.notification.classList.remove('show'), 3000);
                },
                showReceiptModal: (sale) => {
                    const { receiptContent, receiptModal } = App.DOM;
                    let text = `        ** A√ßa√≠ da Serra **\n--------------------------------\nData: ${sale.date}\n\n`;
                    
                    const fee = (sale.deliveryInfo && sale.deliveryInfo.mode === 'entrega') ? sale.deliveryInfo.fee : 0;
                    
                    if (sale.deliveryInfo && sale.deliveryInfo.mode === 'entrega') {
                        text += `         *** ENTREGA ***\n`;
                        if(sale.deliveryInfo.name) text += `Cliente: ${sale.deliveryInfo.name}\n`;
                        if(sale.deliveryInfo.address) text += `Endere√ßo: ${sale.deliveryInfo.address}\n`;
                        text += `--------------------------------\n`;
                    }
                    
                    text += `Itens:\n`;
                    sale.items.forEach(item => {
                        text += `${item.name.padEnd(20)}R$ ${item.totalPrice.toFixed(2).padStart(7)}\n`;
                        if (item.type === 'weight') text += `  (${item.weightGrams}g)\n`;
                    });
                    
                    if (fee > 0) {
                        text += `Taxa Entrega:`.padEnd(20) + `R$ ${fee.toFixed(2).padStart(7)}\n`;
                    }
                    
                    text += `--------------------------------\nTOTAL:`.padEnd(22) + `R$ ${sale.total.toFixed(2).padStart(7)}\n`;
                    text += `Pagamento: ${App.utils.getPaymentMethodName(sale.paymentMethod)}\n`;
                    if (sale.paymentMethod === 'cash') text += `Recebido: R$ ${sale.cashReceived.toFixed(2)}\nTroco: R$ ${sale.change.toFixed(2)}\n`;
                    text += `\n     Obrigado pela prefer√™ncia!`;
                    text += `\n            Volte Sempre!`;
                    receiptContent.textContent = text;
                    receiptModal.style.display = 'flex';
                },
            },

            storage: {
                load() {
                    const salesHistory = localStorage.getItem('salesHistory');
                    const products = localStorage.getItem('products');
                    const acaiPrice = localStorage.getItem('a√ßa√≠PricePerKg');
                    const sorvetePrice = localStorage.getItem('sorvetePricePerKg'); 
                    const deletePassword = localStorage.getItem('deletePassword');
                    const openOrders = localStorage.getItem('openOrders'); 
                    
                    if(salesHistory) App.state.salesHistory = JSON.parse(salesHistory);
                    if(products) App.state.products = JSON.parse(products);
                    if(acaiPrice) App.state.config.a√ßa√≠PricePerKg = parseFloat(acaiPrice);
                    if(sorvetePrice) App.state.config.sorvetePricePerKg = parseFloat(sorvetePrice);
                    if(deletePassword) App.state.config.deletePassword = deletePassword;
                    if(openOrders) App.state.openOrders = JSON.parse(openOrders); 
                },
                saveSalesHistory() {
                    localStorage.setItem('salesHistory', JSON.stringify(App.state.salesHistory));
                },
                saveConfig() {
                    localStorage.setItem('a√ßa√≠PricePerKg', App.state.config.a√ßa√≠PricePerKg);
                    localStorage.setItem('sorvetePricePerKg', App.state.config.sorvetePricePerKg);
                    localStorage.setItem('deletePassword', App.state.config.deletePassword);
                },
                 saveProducts() {
                     localStorage.setItem('products', JSON.stringify(App.state.products));
                },
                saveOpenOrders() { 
                    localStorage.setItem('openOrders', JSON.stringify(App.state.openOrders));
                }
            }
        };

        App.init();
    });
    </script>
>>>>>>> ab2cce1b4a080953063d798756a6778ecf8529bd
</body>
</html>
